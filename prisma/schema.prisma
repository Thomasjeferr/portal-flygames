generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String?
  passwordHash     String    @map("password_hash")
  role             String    @default("user") // "user" | "admin" | "club_viewer"
  emailVerified    Boolean   @default(false) @map("email_verified")
  mustChangePassword Boolean @default(false) @map("must_change_password")
  resetToken       String?   @map("reset_token")
  resetExpires     DateTime? @map("reset_expires")
  favoriteTeamId   String?   @map("favorite_team_id")
  avatarUrl        String?   @map("avatar_url")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  subscription      Subscription?
  sessions          Session[]
  purchases         Purchase[]
  livePurchases     LivePurchase[]
  emailTokens       EmailToken[]
  clubViewerAccount ClubViewerAccount?
  teamManagers      TeamManager[]
  partners          Partner[]
  favoriteTeam      Team?     @relation("UserFavoriteTeam", fields: [favoriteTeamId], references: [id], onDelete: SetNull)
  sponsorOrders     SponsorOrder[]
  watchProgress     WatchProgress[]
  teamRequests      TeamRequest[]
  tournamentSubscriptions TournamentSubscription[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subscription {
  id                    String    @id @default(cuid())
  userId                String    @unique @map("user_id")
  planId                String?   @map("plan_id")
  active                Boolean   @default(false)
  startDate             DateTime  @map("start_date")
  endDate               DateTime  @map("end_date")
  paymentGateway        String?   @map("payment_gateway") // stripe | woovi | manual
  externalSubscriptionId String?  @map("external_subscription_id")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan? @relation(fields: [planId], references: [id], onDelete: SetNull)
}

model Category {
  id        String   @id @default(cuid())
  name      String   @map("name")
  slug      String   @unique @map("slug")
  order     Int      @default(0) @map("order")
  active    Boolean  @default(true) @map("active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  games              Game[]
  preSaleGamesGrade  PreSaleGame[]  // pré-estreias que, quando publicadas, aparecem nesta categoria na grade
}

model Team {
  id             String    @id @default(cuid())
  name           String    @map("name")
  shortName      String?   @map("short_name")
  slug           String    @unique @map("slug")
  city           String?   @map("city")
  state          String?   @map("state")
  foundedYear    Int?      @map("founded_year")
  colors         String?   @map("colors") // JSON: { primary, secondary }
  crestUrl       String?   @map("crest_url")
  instagram      String?   @map("instagram")
  whatsapp       String?   @map("whatsapp")
  description      String?   @map("description")
  responsibleName   String?   @map("responsible_name") // nome do responsável (formulário cadastro)
  responsibleEmail  String?   @map("responsible_email") // e-mail para confirmação e aprovação
  panelAccessToken  String?   @unique @map("panel_access_token") // link de acesso ao painel (enviado por e-mail)
  panelTokenExpiresAt DateTime? @map("panel_token_expires_at")
  isActive          Boolean   @default(true) @map("is_active")
  approvalStatus   String    @default("approved") @map("approval_status") // approved | pending | rejected
  payoutPixKey     String?   @map("payout_pix_key")
  payoutName     String?   @map("payout_name")
  payoutDocument String?   @map("payout_document")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  homeGames        Game[]         @relation("HomeTeam")
  awayGames        Game[]         @relation("AwayTeam")
  homeLives        Live[]         @relation("HomeLive")
  awayLives        Live[]         @relation("AwayLive")
  homePreSaleGames PreSaleGame[]  @relation("HomePreSaleGame")
  awayPreSaleGames PreSaleGame[]  @relation("AwayPreSaleGame")
  sponsors         Sponsor[]
  sponsorOrders SponsorOrder[]
  sponsorshipEarnings TeamSponsorshipEarning[]
  planEarnings        TeamPlanEarning[]
  withdrawals         TeamWithdrawal[]
  purchases           Purchase[]
  managers            TeamManager[]
  members             TeamMember[]
  favoritedByUsers    User[]         @relation("UserFavoriteTeam")
  sumulaApprovals     GameSumulaApproval[]
  playerMatchStats    PlayerMatchStats[]
  tournamentTeams     TournamentTeam[]
  tournamentMatchesAsA TournamentMatch[] @relation("MatchTeamA")
  tournamentMatchesAsB TournamentMatch[] @relation("MatchTeamB")
  tournamentMatchesWon TournamentMatch[] @relation("MatchWinner")
  tournamentSubscriptionsAsSupported TournamentSubscription[]
}

// Responsáveis pelo time (usuários que gerenciam o time no painel do clube)
model TeamManager {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  teamId    String   @map("team_id")
  role      String   @default("OWNER") @map("role") // OWNER | ASSISTANT
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("team_managers")
}

// Solicitações de cadastro de time (torcedor não encontrou o time e pediu para o portal/responsável)
model TeamRequest {
  id        String   @id @default(cuid())
  teamName  String?  @map("team_name")
  userId    String?  @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("team_requests")
}

// Elenco / membros do time (jogadores, comissão técnica, staff)
model TeamMember {
  id        String   @id @default(cuid())
  teamId    String   @map("team_id")
  name      String   @map("name")
  role      String   @map("role") // PLAYER | COACH | STAFF | GOALKEEPER | etc
  number    Int?     @map("number")
  position  String?  @map("position")
  photoUrl  String?  @map("photo_url") // foto opcional do jogador
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  playerMatchStats PlayerMatchStats[]

  @@map("team_members")
}

model Game {
  id           String    @id @default(cuid())
  title        String
  slug         String    @unique
  championship String    @map("championship")
  gameDate     DateTime  @map("game_date")
  description  String?
  videoUrl     String?   @map("video_url")
  thumbnailUrl String?   @map("thumbnail_url")
  featured     Boolean   @default(false)
  categoryId   String?   @map("category_id")
  homeTeamId   String?   @map("home_team_id")
  awayTeamId   String?   @map("away_team_id")
  order        Int       @default(0) @map("order")
  displayMode  String    @default("internal") @map("display_mode") // internal | public_no_media | public_with_media
  homeScore    Int?      @map("home_score")
  awayScore    Int?      @map("away_score")
  venue        String?   @map("venue")
  referee      String?   @map("referee")
  sumulaPublishedAt DateTime? @map("sumula_published_at") // quando o admin publicou a súmula para os times
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  category    Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  homeTeam    Team?      @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: SetNull)
  awayTeam    Team?      @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: SetNull)
  purchases   Purchase[]
  homeBanners HomeBanner[]
  playEvents  PlayEvent[]
  watchProgress WatchProgress[]
  sumulaApprovals GameSumulaApproval[]
  playerMatchStats PlayerMatchStats[]
}

// Aprovação da súmula por time (mandante e visitante aprovam ou rejeitam)
model GameSumulaApproval {
  id              String    @id @default(cuid())
  gameId          String    @map("game_id")
  teamId          String    @map("team_id")
  status          String    @map("status") // PENDENTE | APROVADA | REJEITADA
  rejectionReason String?   @map("rejection_reason")
  rejectedAt      DateTime? @map("rejected_at")
  approvedAt      DateTime? @map("approved_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([gameId, teamId])
  @@map("game_sumula_approvals")
}

// Estatísticas do jogador na partida (preenchidas pelo admin na súmula)
model PlayerMatchStats {
  id          String   @id @default(cuid())
  gameId      String   @map("game_id")
  teamId      String   @map("team_id")
  teamMemberId String  @map("team_member_id")
  goals       Int      @default(0) @map("goals")
  assists     Int      @default(0) @map("assists")
  fouls       Int      @default(0) @map("fouls")
  yellowCard  Boolean  @default(false) @map("yellow_card")
  redCard     Boolean  @default(false) @map("red_card")
  highlight   Boolean  @default(false) @map("highlight") // destaque
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  game       Game       @relation(fields: [gameId], references: [id], onDelete: Cascade)
  team       Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@unique([gameId, teamMemberId])
  @@map("player_match_stats")
}

model Plan {
  id                String   @id @default(cuid())
  name              String   @map("name")
  type              String   @map("type") // unitario | recorrente
  periodicity       String   @map("periodicity") // mensal | anual | personalizado
  price             Float    @map("price")
  description       String?  @map("description")
  active            Boolean  @default(true) @map("active")
  acessoTotal       Boolean  @default(true) @map("acesso_total")
  duracaoDias       Int?     @map("duracao_dias") // null = ilimitado para unitário
  renovacaoAuto     Boolean  @default(false) @map("renovacao_auto")
  featured          Boolean  @default(false) @map("featured") // destaca plano na página pública (Mais escolhido)
  teamPayoutPercent       Int      @default(0) @map("team_payout_percent") // 0-100: % que vai para o time (time de coração)
  partnerCommissionPercent Int     @default(0) @map("partner_commission_percent") // 0-100: % comissão para parceiro que indicar (0 = usa % do cadastro do parceiro)
  maxConcurrentStreams Int?  @map("max_concurrent_streams") // null = sem limite explícito
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  purchases     Purchase[]
  subscriptions Subscription[]
}

model PaymentConfig {
  id                     String   @id @default(cuid())
  wooviApiKey            String?  @map("woovi_api_key")
  wooviWebhookSecret     String?  @map("woovi_webhook_secret")
  stripeSecretKey        String?  @map("stripe_secret_key")
  stripeWebhookSecret    String?  @map("stripe_webhook_secret")
  stripePublishableKey   String?  @map("stripe_publishable_key")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
}

// Banner frontal da home: imagem ou vídeo (YouTube/PandaVideo) + overlay (legado)
model HeroConfig {
  id                String   @id @default(cuid())
  heroType          String   @default("none") @map("hero_type") // none | image | youtube | pandavideo
  heroMediaUrl      String?  @map("hero_media_url")
  overlayColor      String   @default("#000000") @map("overlay_color") // hex
  overlayOpacity    Float    @default(0.5) @map("overlay_opacity") // 0-1
  videoStartSeconds Int?    @map("video_start_seconds")
  videoEndSeconds   Int?    @map("video_end_seconds")
  videoLoop         Boolean  @default(true) @map("video_loop")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
}

// Hero Banner Inteligente - carrossel configurável via Admin
model HomeBanner {
  id                  String    @id @default(cuid())
  isActive            Boolean   @default(true) @map("is_active")
  priority            Int       @default(0) @map("priority")
  type                String    @map("type") // MANUAL | FEATURED_GAME | FEATURED_PRE_SALE | FEATURED_LIVE

  badgeText           String?   @map("badge_text")
  headline            String?   @map("headline")
  subheadline         String?   @map("subheadline")

  useDefaultCta       Boolean   @default(true) @map("use_default_cta")
  primaryCtaText      String?   @map("primary_cta_text")
  primaryCtaUrl       String?   @map("primary_cta_url")
  secondaryCtaText    String?   @map("secondary_cta_text")
  secondaryCtaUrl     String?   @map("secondary_cta_url")

  mediaType           String    @default("NONE") @map("media_type") // IMAGE | YOUTUBE_VIDEO | MP4_VIDEO | NONE
  mediaUrl            String?   @map("media_url")
  videoStartSeconds   Int       @default(0) @map("video_start_seconds")
  videoEndSeconds     Int?      @map("video_end_seconds")
  loop                Boolean   @default(true) @map("loop")
  mute                Boolean   @default(true) @map("mute")

  mobileMediaType     String    @default("NONE") @map("mobile_media_type") // NONE = usa desktop | IMAGE | YOUTUBE_VIDEO | MP4_VIDEO
  mobileMediaUrl      String?   @map("mobile_media_url")

  overlayColorHex     String    @default("#000000") @map("overlay_color_hex")
  overlayOpacity      Int       @default(75) @map("overlay_opacity") // 0-100

  heightPreset        String    @default("md") @map("height_preset") // sm | md | lg | xl | full
  // Altura personalizada em pixels (se definido, sobrescreve o preset)
  customHeightPx      Int?      @map("custom_height_px")

  secondaryMediaType  String    @default("NONE") @map("secondary_media_type") // NONE | IMAGE | YOUTUBE_VIDEO | MP4_VIDEO
  secondaryMediaUrl   String?   @map("secondary_media_url")

  gameId              String?   @map("game_id")
  preSaleId           String?   @map("pre_sale_id")
  liveId              String?   @map("live_id")

  showOnlyWhenReady   Boolean   @default(true) @map("show_only_when_ready")
  startAt             DateTime? @map("start_at")
  endAt               DateTime? @map("end_at")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  game    Game?       @relation(fields: [gameId], references: [id], onDelete: SetNull)
  preSale PreSaleGame? @relation(fields: [preSaleId], references: [id], onDelete: SetNull)
  live    Live?       @relation(fields: [liveId], references: [id], onDelete: SetNull)
}

// ========== PRÉ-ESTREIA ==========
// Categorias: scope CLUB = só Pré-estreia Clubes, META = só Pré-estreia Meta (não misturar)
model PreSaleCategory {
  id        String   @id @default(cuid())
  name      String   @map("name")
  slug      String   @unique @map("slug")
  type      String   @map("type") // NORMAL | SPECIAL
  scope     String   @default("CLUB") @map("scope") // CLUB | META
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  preSaleGamesAsSpecial PreSaleGame[]           @relation("SpecialCategory")
  preSaleGameCategories PreSaleGameCategory[]
}

model PreSaleGame {
  id                    String    @id @default(cuid())
  title                 String    @map("title")
  description           String    @map("description")
  thumbnailUrl          String    @map("thumbnail_url")
  videoUrl              String?   @map("video_url")
  status                String    @default("PRE_SALE") @map("status") // PRE_SALE | FUNDED | PUBLISHED
  // Modelo atual: clubes financiam slots. Opcional quando metaEnabled (Pré-estreia Meta).
  specialCategoryId     String?   @map("special_category_id")
  gradeCategoryId       String?   @map("grade_category_id")  // categoria da grade convencional (quando publicado)
  featured              Boolean   @default(false) @map("featured")
  maxSimultaneousPerClub Int      @map("max_simultaneous_per_club")
  clubAPrice            Float     @map("club_a_price")
  clubBPrice            Float     @map("club_b_price")
  fundedClubsCount      Int       @default(0) @map("funded_clubs_count")
  // Novo modo: pré-estreia com meta de assinantes por time
  metaEnabled           Boolean   @default(false) @map("meta_enabled")
  metaExtraPerTeam      Int?      @map("meta_extra_per_team")     // quantos novos assinantes além do baseline cada time precisa
  baselineHomeSubs      Int?      @map("baseline_home_subs")      // assinantes ativos do mandante no momento da criação
  baselineAwaySubs      Int?      @map("baseline_away_subs")      // assinantes ativos do visitante no momento da criação
  metaHomeTotal         Int?      @map("meta_home_total")         // baselineHomeSubs + metaExtraPerTeam
  metaAwayTotal         Int?      @map("meta_away_total")         // baselineAwaySubs + metaExtraPerTeam
  slug                  String    @unique @map("slug")
  homeTeamId            String?   @map("home_team_id")
  awayTeamId            String?   @map("away_team_id")
  premiereAt             DateTime? @map("premiere_at")   // Data e hora da estreia (informativo)
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  homeTeam          Team?                 @relation("HomePreSaleGame", fields: [homeTeamId], references: [id], onDelete: SetNull)
  awayTeam          Team?                 @relation("AwayPreSaleGame", fields: [awayTeamId], references: [id], onDelete: SetNull)
  specialCategory   PreSaleCategory?      @relation("SpecialCategory", fields: [specialCategoryId], references: [id], onDelete: Restrict)
  gradeCategory     Category?             @relation(fields: [gradeCategoryId], references: [id], onDelete: SetNull)
  normalCategories  PreSaleGameCategory[]
  clubSlots         PreSaleClubSlot[]
  streamSessions   ClubStreamSession[]
  homeBanners      HomeBanner[]
}

model PreSaleGameCategory {
  id             String      @id @default(cuid())
  preSaleGameId  String      @map("pre_sale_game_id")
  categoryId     String      @map("category_id")
  createdAt      DateTime    @default(now()) @map("created_at")

  preSaleGame PreSaleGame    @relation(fields: [preSaleGameId], references: [id], onDelete: Cascade)
  category    PreSaleCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([preSaleGameId, categoryId])
}

model PreSaleClubSlot {
  id                  String     @id @default(cuid())
  preSaleGameId       String     @map("pre_sale_game_id")
  slotIndex           Int        @map("slot_index") // 1 or 2
  clubCode            String     @unique @map("club_code")
  responsibleName     String     @map("responsible_name")
  responsibleEmail    String?    @map("responsible_email")
  clubName            String     @map("club_name")
  teamMemberCount     Int        @map("team_member_count")
  contractVersion     String     @map("contract_version")
  termsAcceptedAt     DateTime   @map("terms_accepted_at")
  paymentStatus       String     @default("PENDING") @map("payment_status") // PENDING | PAID | FAILED
  paymentProvider     String?    @map("payment_provider") // WOOVI | STRIPE
  paymentReference    String?    @map("payment_reference")
  paidAt              DateTime?  @map("paid_at")
  credentialsSentAt   DateTime?  @map("credentials_sent_at")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")

  preSaleGame      PreSaleGame       @relation(fields: [preSaleGameId], references: [id], onDelete: Cascade)
  clubViewerAccount ClubViewerAccount?
}

model ClubViewerAccount {
  id                 String   @id @default(cuid())
  userId             String   @unique @map("user_id")
  preSaleClubSlotId  String   @unique @map("pre_sale_club_slot_id")
  loginUsername      String   @unique @map("login_username") // usuário exibido ao clube e no admin
  createdAt          DateTime @default(now()) @map("created_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  preSaleClubSlot PreSaleClubSlot @relation(fields: [preSaleClubSlotId], references: [id], onDelete: Cascade)
}

model ClubStreamSession {
  id             String    @id @default(cuid())
  preSaleGameId  String    @map("pre_sale_game_id")
  clubCode       String    @map("club_code")
  sessionToken   String    @unique @map("session_token")
  userId         String?   @map("user_id")
  deviceId       String?   @map("device_id")
  lastHeartbeatAt DateTime @map("last_heartbeat_at")
  expiresAt      DateTime  @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  preSaleGame PreSaleGame @relation(fields: [preSaleGameId], references: [id], onDelete: Cascade)
}

// ========== FIM PRÉ-ESTREIA ==========

// Planos de Patrocínio (pacotes vendíveis)
model SponsorPlan {
  id                String   @id @default(cuid())
  name              String   @map("name")
  price             Float    @map("price")
  billingPeriod     String   @default("monthly") @map("billing_period") // monthly | quarterly | yearly
  benefits          String   @default("[]") @map("benefits") // JSON array de strings
  featuresFlags     String   @default("{}") @map("features_flags") // JSON ex: { show_in_footer, show_in_player, ... }
  teamPayoutPercent        Int      @default(0) @map("team_payout_percent") // 0-100: % do valor que vai para o time
  partnerCommissionPercent Int      @default(0) @map("partner_commission_percent") // 0-100: % comissão para parceiro que indicar (0 = usa % do cadastro do parceiro)
  sortOrder         Int      @default(0) @map("sort_order")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  sponsors      Sponsor[]
  sponsorOrders SponsorOrder[]
}

// Pedido de patrocínio (compra pelo site, antes de virar Sponsor)
model SponsorOrder {
  id               String    @id @default(cuid())
  sponsorPlanId    String    @map("sponsor_plan_id")
  teamId           String?   @map("team_id")
  partnerId        String?   @map("partner_id")
  userId           String?   @map("user_id") // preenchido quando o usuário está logado ao patrocinar (para liberar acesso a resultados)
  companyName      String    @map("company_name")
  email            String    @map("email")
  websiteUrl       String?   @map("website_url")
  whatsapp         String?   @map("whatsapp")
  instagram        String?   @map("instagram")
  logoUrl          String    @map("logo_url")
  amountCents      Int       @map("amount_cents")
  amountToTeamCents Int      @default(0) @map("amount_to_team_cents")
  paymentStatus    String    @default("pending") @map("payment_status") // pending | paid | failed
  paymentGateway   String?   @map("payment_gateway")
  externalId       String?   @map("external_id")
  utmSource        String?   @map("utm_source")
  utmMedium        String?   @map("utm_medium")
  utmCampaign      String?   @map("utm_campaign")
  utmContent       String?   @map("utm_content")
  utmTerm          String?   @map("utm_term")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  sponsorPlan SponsorPlan @relation(fields: [sponsorPlanId], references: [id], onDelete: Restrict)
  team        Team?       @relation(fields: [teamId], references: [id], onDelete: SetNull)
  partner     Partner?    @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  earnings    TeamSponsorshipEarning[]
}

// Ganho do time com patrocínio (comissão)
model TeamSponsorshipEarning {
  id               String    @id @default(cuid())
  teamId           String    @map("team_id")
  sponsorOrderId   String    @map("sponsor_order_id")
  amountCents      Int       @map("amount_cents")
  status           String    @default("pending") @map("status") // pending | paid
  paidAt           DateTime? @map("paid_at")
  paymentReference String?   @map("payment_reference")
  createdAt        DateTime  @default(now()) @map("created_at")

  team                       Team                         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  sponsorOrder               SponsorOrder                 @relation(fields: [sponsorOrderId], references: [id], onDelete: Cascade)
  withdrawalSponsorshipItems TeamWithdrawalSponsorshipItem[]

  @@unique([teamId, sponsorOrderId])
}

// Patrocinadores
model Sponsor {
  id         String       @id @default(cuid())
  name       String       @map("name")
  websiteUrl String?      @map("website_url")
  whatsapp   String?      @map("whatsapp")
  instagram  String?      @map("instagram")
  logoUrl    String       @map("logo_url")
  tier       String       @default("APOIO") @map("tier") // MASTER | OFICIAL | APOIO
  priority   Int          @default(0) @map("priority")
  isActive   Boolean      @default(true) @map("is_active")
  startAt    DateTime?    @map("start_at")
  endAt      DateTime?    @map("end_at")
  planId     String?      @map("plan_id")
  teamId     String?      @map("team_id")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  plan SponsorPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)
  team Team?        @relation(fields: [teamId], references: [id], onDelete: SetNull)
}

// Configurações gerais do site (contato, redes, CNPJ)
model SiteSettings {
  id                     String   @id @default(cuid())
  supportEmail           String?  @map("support_email")
  adminCredentialsEmail  String?  @map("admin_credentials_email") // e-mail que recebe credenciais pré-estreia
  whatsappNumber         String?  @map("whatsapp_number")
  instagramUrl           String?  @map("instagram_url")
  tiktokUrl              String?  @map("tiktok_url")
  youtubeUrl             String?  @map("youtube_url")
  companyName            String?  @map("company_name")
  companyCnpj            String?  @map("company_cnpj")
  gaMeasurementId        String?  @map("ga_measurement_id")
  fbPixelId              String?  @map("fb_pixel_id")
  tiktokPixelId          String?  @map("tiktok_pixel_id")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
}

// ========== E-MAILS TRANSiCIONAIS (Resend) ==========
model EmailSettings {
  id           String   @id @default(cuid())
  fromName     String   @default("Fly Games") @map("from_name")
  fromEmail    String   @default("no-reply@flygames.app") @map("from_email")
  replyTo      String?  @map("reply_to")
  brandColor   String   @default("#22c55e") @map("brand_color")
  logoUrl      String?  @map("logo_url")
  supportEmail String?  @map("support_email")
  whatsappUrl  String?  @map("whatsapp_url")
  footerText   String?  @map("footer_text")
  appBaseUrl   String?  @map("app_base_url")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
}

model EmailTemplate {
  id        String   @id @default(cuid())
  key       String   @unique @map("key") // WELCOME | VERIFY_EMAIL | RESET_PASSWORD | PASSWORD_CHANGED
  subject   String   @map("subject")
  htmlBody  String   @map("html_body")
  isActive  Boolean  @default(true) @map("is_active")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model EmailToken {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  type       String    @map("type") // VERIFY_EMAIL | RESET_PASSWORD
  tokenHash  String    @unique @map("token_hash")
  expiresAt  DateTime  @map("expires_at")
  usedAt     DateTime? @map("used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  ip         String?   @map("ip")
  userAgent  String?   @map("user_agent")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailLog {
  id               String   @id @default(cuid())
  userId           String?  @map("user_id")
  toEmail          String   @map("to_email")
  templateKey      String   @map("template_key")
  provider         String   @default("RESEND") @map("provider")
  status           String   @map("status") // SENT | FAILED
  providerMessageId String? @map("provider_message_id")
  errorMessage     String?  @map("error_message")
  createdAt        DateTime @default(now()) @map("created_at")
}

model RateLimit {
  id          String   @id @default(cuid())
  key         String   @unique @map("key")
  count       Int      @default(0) @map("count")
  windowStart DateTime @map("window_start")
  updatedAt   DateTime @updatedAt @map("updated_at")
}

// ========== ANALYTICS / GEOLOCALIZAÇÃO ==========
model VisitLog {
  id        String   @id @default(cuid())
  ipHash    String   @map("ip_hash") // hash do IP para privacidade
  country   String?  @map("country")
  countryCode String? @map("country_code")
  region    String?  @map("region")
  regionName String? @map("region_name")
  city      String?  @map("city")
  lat       Float?   @map("lat")
  lng       Float?   @map("lng")
  timezone  String?  @map("timezone")
  isp       String?  @map("isp")
  userAgent String?  @map("user_agent")
  pagePath  String   @map("page_path")
  referrer  String?  @map("referrer")
  createdAt DateTime @default(now()) @map("created_at")
}

model IpGeoCache {
  id         String   @id @default(cuid())
  ipHash     String   @unique @map("ip_hash")
  country    String?  @map("country")
  countryCode String? @map("country_code")
  region     String?  @map("region")
  regionName String?  @map("region_name")
  city       String?  @map("city")
  lat        Float?   @map("lat")
  lng        Float?   @map("lng")
  timezone   String?  @map("timezone")
  isp        String?  @map("isp")
  cachedAt   DateTime @default(now()) @map("cached_at")
}

// ========== FIM E-MAILS ==========

model Purchase {
  id                 String    @id @default(cuid())
  userId             String    @map("user_id")
  planId             String    @map("plan_id")
  gameId             String?   @map("game_id") // preenchido para plano unitário (jogo específico)
  teamId             String?   @map("team_id") // time de coração (opcional)
  partnerId          String?   @map("partner_id") // parceiro/revendedor (opcional)
  amountToTeamCents  Int       @default(0) @map("amount_to_team_cents")
  purchasedAt        DateTime  @default(now()) @map("purchased_at")
  expiresAt          DateTime? @map("expires_at") // null = não expira
  paymentStatus      String    @default("pending") @map("payment_status") // pending | paid | failed | refunded
  paymentGateway     String?   @map("payment_gateway") // woovi | stripe | manual
  externalId         String?   @map("external_id") // id da cobrança no gateway
  utmSource          String?   @map("utm_source")
  utmMedium          String?   @map("utm_medium")
  utmCampaign        String?   @map("utm_campaign")
  utmContent         String?   @map("utm_content")
  utmTerm            String?   @map("utm_term")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan    Plan     @relation(fields: [planId], references: [id], onDelete: Restrict)
  game    Game?    @relation(fields: [gameId], references: [id], onDelete: SetNull)
  team    Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  partner Partner? @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  planEarnings TeamPlanEarning[]
}

// Programa de parceiros / revendedores
model Partner {
  id                       String   @id @default(cuid())
  userId                   String?  @map("user_id")
  type                     String   @default("revendedor") @map("type") // revendedor | influencer | lojista | outro
  status                   String   @default("pending") @map("status") // pending | approved | rejected | blocked
  name                     String   @map("name")
  companyName              String?  @map("company_name")
  document                 String?  @map("document") // CPF ou CNPJ
  whatsapp                 String?  @map("whatsapp")
  city                     String?  @map("city")
  state                    String?  @map("state")
  refCode                  String   @unique @map("ref_code")
  planCommissionPercent    Int      @default(0) @map("plan_commission_percent") // % sobre planos/assinaturas
  gameCommissionPercent    Int      @default(0) @map("game_commission_percent") // % sobre jogos/lives avulsos
  sponsorCommissionPercent Int      @default(0) @map("sponsor_commission_percent") // % sobre patrocínio
  pixKey                   String?  @map("pix_key")
  pixKeyType               String?  @map("pix_key_type") // cpf | cnpj | email | phone | aleatoria
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  user          User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  purchases     Purchase[]
  sponsorOrders SponsorOrder[]
  earnings      PartnerEarning[]
  withdrawals   PartnerWithdrawal[]
}

model PartnerEarning {
  id               String    @id @default(cuid())
  partnerId        String    @map("partner_id")
  sourceType       String    @map("source_type") // purchase | sponsor
  sourceId         String    @map("source_id")
  grossAmountCents Int       @map("gross_amount_cents")
  commissionPercent Int      @map("commission_percent")
  amountCents      Int       @map("amount_cents")
  status           String    @default("pending") @map("status") // pending | paid
  paidAt           DateTime? @map("paid_at")
  paymentReference String?   @map("payment_reference")
  createdAt        DateTime  @default(now()) @map("created_at")

  partner         Partner                 @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  withdrawalItems PartnerWithdrawalItem[]
}

model PartnerWithdrawal {
  id               String   @id @default(cuid())
  partnerId        String   @map("partner_id")
  amountCents      Int      @map("amount_cents")
  status           String   @default("requested") @map("status") // requested | processing | paid | canceled
  requestedAt      DateTime @default(now()) @map("requested_at")
  paidAt           DateTime? @map("paid_at")
  paymentReference String?  @map("payment_reference")
  createdAt        DateTime @default(now()) @map("created_at")
  receiptUrl       String?  @map("receipt_url")
  pixKey           String?  @map("pix_key")
  pixKeyType       String?  @map("pix_key_type") // cpf | cnpj | email | phone | aleatoria
  pixName          String?  @map("pix_name") // nome do titular / favorecido

  partner Partner               @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  items   PartnerWithdrawalItem[]
}

model PartnerWithdrawalItem {
  id           String  @id @default(cuid())
  withdrawalId String  @map("withdrawal_id")
  earningId    String  @map("earning_id")
  amountCents  Int     @map("amount_cents")

  withdrawal PartnerWithdrawal @relation(fields: [withdrawalId], references: [id], onDelete: Cascade)
  earning    PartnerEarning    @relation(fields: [earningId], references: [id], onDelete: Cascade)
}

// Ganho do time com compra de plano/jogo (comissão do time de coração)
model TeamPlanEarning {
  id               String    @id @default(cuid())
  teamId           String    @map("team_id")
  purchaseId       String    @map("purchase_id")
  amountCents      Int       @map("amount_cents")
  status           String    @default("pending") @map("status") // pending | paid
  paidAt           DateTime? @map("paid_at")
  paymentReference String?   @map("payment_reference")
  createdAt        DateTime  @default(now()) @map("created_at")

  team              Team                     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  purchase          Purchase                 @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  withdrawalPlanItems TeamWithdrawalPlanItem[]

  @@unique([teamId, purchaseId])
}

model TeamWithdrawal {
  id               String   @id @default(cuid())
  teamId           String   @map("team_id")
  amountCents      Int      @map("amount_cents")
  status           String   @default("requested") @map("status") // requested | processing | paid | canceled
  requestedAt      DateTime @default(now()) @map("requested_at")
  paidAt           DateTime? @map("paid_at")
  paymentReference String?  @map("payment_reference")
  createdAt        DateTime @default(now()) @map("created_at")
  receiptUrl       String?  @map("receipt_url")
  pixKey           String?  @map("pix_key")
  pixKeyType       String?  @map("pix_key_type") // cpf | cnpj | email | phone | aleatoria
  pixName          String?  @map("pix_name") // nome do titular / favorecido

  team               Team                          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  planItems          TeamWithdrawalPlanItem[]
  sponsorshipItems   TeamWithdrawalSponsorshipItem[]
}

model TeamWithdrawalPlanItem {
  id           String @id @default(cuid())
  withdrawalId String @map("withdrawal_id")
  earningId    String @map("earning_id")
  amountCents  Int    @map("amount_cents")

  withdrawal TeamWithdrawal  @relation(fields: [withdrawalId], references: [id], onDelete: Cascade)
  earning    TeamPlanEarning @relation(fields: [earningId], references: [id], onDelete: Cascade)
}

model TeamWithdrawalSponsorshipItem {
  id           String @id @default(cuid())
  withdrawalId String @map("withdrawal_id")
  earningId    String @map("earning_id")
  amountCents  Int    @map("amount_cents")

  withdrawal TeamWithdrawal        @relation(fields: [withdrawalId], references: [id], onDelete: Cascade)
  earning    TeamSponsorshipEarning @relation(fields: [earningId], references: [id], onDelete: Cascade)
}

// ========== DASHBOARD / ANALYTICS ==========
model PlayEvent {
  id        String    @id @default(cuid())
  userId    String?   @map("user_id")
  gameId    String    @map("game_id")
  createdAt DateTime  @default(now()) @map("created_at")

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

// Progresso de visualização (Continuar assistindo) — posição em segundos por usuário/jogo
model WatchProgress {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  gameId          String   @map("game_id")
  positionSeconds Int      @map("position_seconds")
  durationSeconds Int?     @map("duration_seconds") // opcional, para exibir % na barra
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@map("watch_progress")
}

model Payment {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  provider  String   @map("provider") // STRIPE | WOOVI
  type      String   @map("type") // SUBSCRIPTION | ONE_TIME
  amount    Float    @map("amount")
  status    String   @map("status") // PAID | PENDING | FAILED
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

// ========== LIVES (Cloudflare Stream Live + OBS) ==========
model Live {
  id                      String    @id @default(cuid())
  title                   String    @map("title")
  description             String?   @map("description")
  thumbnailUrl            String?   @map("thumbnail_url")
  cloudflareLiveInputId   String?   @unique @map("cloudflare_live_input_id")
  cloudflarePlaybackId    String?   @map("cloudflare_playback_id") // video uid quando gravado (replay)
  status                  String    @default("SCHEDULED") @map("status") // SCHEDULED | LIVE | ENDED
  startAt                 DateTime? @map("start_at")
  endAt                   DateTime? @map("end_at")
  requireSubscription     Boolean   @default(true) @map("require_subscription")
  allowOneTimePurchase    Boolean   @default(false) @map("allow_one_time_purchase")
  allowChat               Boolean   @default(false) @map("allow_chat")
  homeTeamId              String?   @map("home_team_id")
  awayTeamId              String?   @map("away_team_id")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  homeTeam    Team?         @relation("HomeLive", fields: [homeTeamId], references: [id], onDelete: SetNull)
  awayTeam    Team?         @relation("AwayLive", fields: [awayTeamId], references: [id], onDelete: SetNull)
  purchases   LivePurchase[]
  homeBanners HomeBanner[]
}

model LivePurchase {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  liveId      String   @map("live_id")
  purchasedAt DateTime @default(now()) @map("purchased_at")
  paymentStatus String @default("paid") @map("payment_status") // paid | pending | refunded

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  live Live @relation(fields: [liveId], references: [id], onDelete: Cascade)

  @@unique([userId, liveId])
  @@map("live_purchases")
}

// ========== FIM LIVES ==========

// ========== COPA MATA-MATA (TOURNAMENTS) ==========
model Tournament {
  id                        String    @id @default(cuid())
  name                      String    @map("name")
  slug                      String    @unique @map("slug")
  season                    String?   @map("season")
  region                    String?   @map("region")
  format                    String    @default("SINGLE_ELIMINATION") @map("format")
  maxTeams                  Int       @map("max_teams") // 1..32
  registrationMode          String    @map("registration_mode") // FREE | PAID | GOAL
  registrationFeeAmount     Float?    @map("registration_fee_amount")
  goalRequiredSupporters    Int?      @map("goal_required_supporters")
  goalPricePerSupporter     Float?    @map("goal_price_per_supporter")
  goalStartAt               DateTime? @map("goal_start_at")
  goalEndAt                  DateTime? @map("goal_end_at")
  lockConfirmationOnGoal     Boolean   @default(true) @map("lock_confirmation_on_goal")
  status                    String    @default("DRAFT") @map("status") // DRAFT | PUBLISHED | IN_PROGRESS | FINISHED
  bracketStatus              String    @default("NONE") @map("bracket_status") // NONE | GENERATED
  createdAt                 DateTime  @default(now()) @map("created_at")
  updatedAt                 DateTime  @updatedAt @map("updated_at")

  teams      TournamentTeam[]
  matches   TournamentMatch[]
  subscriptions TournamentSubscription[]
}

model TournamentTeam {
  id                    String    @id @default(cuid())
  tournamentId          String    @map("tournament_id")
  teamId                String    @map("team_id")
  registrationType      String    @map("registration_type") // FREE | PAID | GOAL
  teamStatus            String    @map("team_status") // APPLIED | IN_GOAL | CONFIRMED | REJECTED | ELIMINATED
  paymentStatus         String?   @map("payment_status") // pending | paid | failed (quando PAID)
  paymentGateway        String?   @map("payment_gateway") // stripe | woovi
  paymentExternalId     String?   @map("payment_external_id") // id do PaymentIntent, cobrança Woovi ou Stripe Subscription id
  registrationStripeSubscriptionId String? @map("registration_stripe_subscription_id") // assinatura recorrente (pagador vira assinante)
  goalStatus            String?   @map("goal_status") // PENDING | ACHIEVED | EXPIRED (quando GOAL)
  goalCurrentSupporters Int       @default(0) @map("goal_current_supporters")
  goalAchievedAt        DateTime? @map("goal_achieved_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  team       Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, teamId])
  @@map("tournament_teams")
}

model TournamentMatch {
  id              String    @id @default(cuid())
  tournamentId    String    @map("tournament_id")
  round           Int       @map("round") // 32 | 16 | 8 | 4 | 2
  matchNumber     Int       @map("match_number")
  teamAId         String?   @map("team_a_id")
  teamBId         String?   @map("team_b_id")
  scheduledAt     DateTime? @map("scheduled_at")
  location        String?   @map("location")
  status          String    @default("SCHEDULED") @map("status") // SCHEDULED | LIVE | FINISHED
  scoreA          Int?      @map("score_a")
  scoreB          Int?      @map("score_b")
  penaltiesA      Int?      @map("penalties_a")
  penaltiesB      Int?      @map("penalties_b")
  winnerTeamId    String?   @map("winner_team_id")
  nextMatchId     String?   @map("next_match_id")
  liveUrl         String?   @map("live_url")
  replayUrl       String?   @map("replay_url")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  tournament  Tournament    @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  teamA       Team?         @relation("MatchTeamA", fields: [teamAId], references: [id], onDelete: SetNull)
  teamB       Team?         @relation("MatchTeamB", fields: [teamBId], references: [id], onDelete: SetNull)
  winnerTeam  Team?         @relation("MatchWinner", fields: [winnerTeamId], references: [id], onDelete: SetNull)
  nextMatch   TournamentMatch?  @relation("MatchNext", fields: [nextMatchId], references: [id], onDelete: SetNull)
  prevMatches TournamentMatch[] @relation("MatchNext")

  @@map("tournament_matches")
}

model TournamentSubscription {
  id                    String    @id @default(cuid())
  userId                String    @map("user_id")
  tournamentId          String    @map("tournament_id")
  teamSupportedId       String    @map("team_supported_id")
  stripeSubscriptionId  String?   @map("stripe_subscription_id")
  startedAt             DateTime  @map("started_at")
  endedAt               DateTime? @map("ended_at")
  status                String    @map("status") // ACTIVE | CANCELED | PAST_DUE
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tournament    Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  teamSupported Team      @relation(fields: [teamSupportedId], references: [id], onDelete: Cascade)

  @@map("tournament_subscriptions")
}

// ========== FIM COPA MATA-MATA ==========

model WebhookEvent {
  id        String   @id @default(cuid())
  provider  String   @map("provider") // STRIPE | WOOVI
  eventId   String   @unique @map("event_id")
  status    String   @map("status") // SUCCESS | FAILED
  createdAt DateTime @default(now()) @map("created_at")
}
