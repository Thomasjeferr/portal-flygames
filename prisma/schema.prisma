generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String    @map("password_hash")
  role          String    @default("user") // "user" | "admin"
  emailVerified Boolean   @default(false) @map("email_verified")
  resetToken    String?   @map("reset_token")
  resetExpires  DateTime? @map("reset_expires")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  subscription  Subscription?
  sessions      Session[]
  purchases     Purchase[]
  emailTokens   EmailToken[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subscription {
  id                    String    @id @default(cuid())
  userId                String    @unique @map("user_id")
  planId                String?   @map("plan_id")
  active                Boolean   @default(false)
  startDate             DateTime  @map("start_date")
  endDate               DateTime  @map("end_date")
  paymentGateway        String?   @map("payment_gateway") // stripe | woovi | manual
  externalSubscriptionId String?  @map("external_subscription_id")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan? @relation(fields: [planId], references: [id], onDelete: SetNull)
}

model Category {
  id        String   @id @default(cuid())
  name      String   @map("name")
  slug      String   @unique @map("slug")
  order     Int      @default(0) @map("order")
  active    Boolean  @default(true) @map("active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  games Game[]
}

model Game {
  id           String    @id @default(cuid())
  title        String
  slug         String    @unique
  championship String    @map("championship")
  gameDate     DateTime  @map("game_date")
  description  String?
  videoUrl     String    @map("video_url")
  thumbnailUrl String?   @map("thumbnail_url")
  featured     Boolean   @default(false)
  categoryId   String?   @map("category_id")
  order        Int       @default(0) @map("order")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  category   Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  purchases  Purchase[]
  homeBanners HomeBanner[]
}

model Plan {
  id             String   @id @default(cuid())
  name           String   @map("name")
  type           String   @map("type") // unitario | recorrente
  periodicity    String   @map("periodicity") // mensal | anual | personalizado
  price          Float    @map("price")
  description    String?  @map("description")
  active         Boolean  @default(true) @map("active")
  acessoTotal    Boolean  @default(true) @map("acesso_total")
  duracaoDias    Int?     @map("duracao_dias") // null = ilimitado para unitário
  renovacaoAuto  Boolean  @default(false) @map("renovacao_auto")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  purchases     Purchase[]
  subscriptions Subscription[]
}

model PaymentConfig {
  id                     String   @id @default(cuid())
  wooviApiKey            String?  @map("woovi_api_key")
  wooviWebhookSecret     String?  @map("woovi_webhook_secret")
  stripeSecretKey        String?  @map("stripe_secret_key")
  stripeWebhookSecret    String?  @map("stripe_webhook_secret")
  stripePublishableKey   String?  @map("stripe_publishable_key")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
}

// Banner frontal da home: imagem ou vídeo (YouTube/PandaVideo) + overlay (legado)
model HeroConfig {
  id                String   @id @default(cuid())
  heroType          String   @default("none") @map("hero_type") // none | image | youtube | pandavideo
  heroMediaUrl      String?  @map("hero_media_url")
  overlayColor      String   @default("#000000") @map("overlay_color") // hex
  overlayOpacity    Float    @default(0.5) @map("overlay_opacity") // 0-1
  videoStartSeconds Int?    @map("video_start_seconds")
  videoEndSeconds   Int?    @map("video_end_seconds")
  videoLoop         Boolean  @default(true) @map("video_loop")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
}

// Hero Banner Inteligente - carrossel configurável via Admin
model HomeBanner {
  id                  String    @id @default(cuid())
  isActive            Boolean   @default(true) @map("is_active")
  priority            Int       @default(0) @map("priority")
  type                String    @map("type") // MANUAL | FEATURED_GAME | FEATURED_PRE_SALE

  badgeText           String?   @map("badge_text")
  headline            String?   @map("headline")
  subheadline         String?   @map("subheadline")

  useDefaultCta       Boolean   @default(true) @map("use_default_cta")
  primaryCtaText      String?   @map("primary_cta_text")
  primaryCtaUrl       String?   @map("primary_cta_url")
  secondaryCtaText    String?   @map("secondary_cta_text")
  secondaryCtaUrl     String?   @map("secondary_cta_url")

  mediaType           String    @default("NONE") @map("media_type") // IMAGE | YOUTUBE_VIDEO | MP4_VIDEO | NONE
  mediaUrl            String?   @map("media_url")
  videoStartSeconds   Int       @default(0) @map("video_start_seconds")
  videoEndSeconds     Int?      @map("video_end_seconds")
  loop                Boolean   @default(true) @map("loop")
  mute                Boolean   @default(true) @map("mute")

  overlayColorHex     String    @default("#000000") @map("overlay_color_hex")
  overlayOpacity      Int       @default(75) @map("overlay_opacity") // 0-100

  heightPreset        String    @default("md") @map("height_preset") // sm | md | lg | xl | full

  secondaryMediaType  String    @default("NONE") @map("secondary_media_type") // NONE | IMAGE | YOUTUBE_VIDEO | MP4_VIDEO
  secondaryMediaUrl   String?   @map("secondary_media_url")

  gameId              String?   @map("game_id")
  preSaleId           String?   @map("pre_sale_id")

  showOnlyWhenReady   Boolean   @default(true) @map("show_only_when_ready")
  startAt             DateTime? @map("start_at")
  endAt               DateTime? @map("end_at")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  game    Game?       @relation(fields: [gameId], references: [id], onDelete: SetNull)
  preSale PreSaleGame? @relation(fields: [preSaleId], references: [id], onDelete: SetNull)
}

// ========== PRÉ-ESTREIA CLUBES ==========
// Categorias para pré-estreia (NORMAL = catálogo, SPECIAL = pré-venda)
model PreSaleCategory {
  id        String   @id @default(cuid())
  name      String   @map("name")
  slug      String   @unique @map("slug")
  type      String   @map("type") // NORMAL | SPECIAL
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  preSaleGamesAsSpecial PreSaleGame[]           @relation("SpecialCategory")
  preSaleGameCategories PreSaleGameCategory[]
}

model PreSaleGame {
  id                    String    @id @default(cuid())
  title                 String    @map("title")
  description           String    @map("description")
  thumbnailUrl          String    @map("thumbnail_url")
  videoUrl              String?   @map("video_url")
  status                String    @default("PRE_SALE") @map("status") // PRE_SALE | FUNDED | PUBLISHED
  specialCategoryId     String    @map("special_category_id")
  featured              Boolean   @default(false) @map("featured")
  maxSimultaneousPerClub Int      @map("max_simultaneous_per_club")
  clubAPrice            Float     @map("club_a_price")
  clubBPrice            Float     @map("club_b_price")
  fundedClubsCount      Int       @default(0) @map("funded_clubs_count")
  slug                  String    @unique @map("slug")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  specialCategory   PreSaleCategory       @relation("SpecialCategory", fields: [specialCategoryId], references: [id], onDelete: Restrict)
  normalCategories  PreSaleGameCategory[]
  clubSlots         PreSaleClubSlot[]
  streamSessions    ClubStreamSession[]
  homeBanners       HomeBanner[]
}

model PreSaleGameCategory {
  id             String      @id @default(cuid())
  preSaleGameId  String      @map("pre_sale_game_id")
  categoryId     String      @map("category_id")
  createdAt      DateTime    @default(now()) @map("created_at")

  preSaleGame PreSaleGame    @relation(fields: [preSaleGameId], references: [id], onDelete: Cascade)
  category    PreSaleCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([preSaleGameId, categoryId])
}

model PreSaleClubSlot {
  id                 String    @id @default(cuid())
  preSaleGameId      String    @map("pre_sale_game_id")
  slotIndex          Int       @map("slot_index") // 1 or 2
  clubCode           String    @unique @map("club_code")
  responsibleName    String    @map("responsible_name")
  clubName           String    @map("club_name")
  teamMemberCount    Int       @map("team_member_count")
  contractVersion    String    @map("contract_version")
  termsAcceptedAt    DateTime  @map("terms_accepted_at")
  paymentStatus      String    @default("PENDING") @map("payment_status") // PENDING | PAID | FAILED
  paymentProvider    String?   @map("payment_provider") // WOOVI | STRIPE
  paymentReference   String?   @map("payment_reference")
  paidAt             DateTime? @map("paid_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  preSaleGame PreSaleGame @relation(fields: [preSaleGameId], references: [id], onDelete: Cascade)
}

model ClubStreamSession {
  id             String    @id @default(cuid())
  preSaleGameId  String    @map("pre_sale_game_id")
  clubCode       String    @map("club_code")
  sessionToken   String    @unique @map("session_token")
  userId         String?   @map("user_id")
  deviceId       String?   @map("device_id")
  lastHeartbeatAt DateTime @map("last_heartbeat_at")
  expiresAt      DateTime  @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  preSaleGame PreSaleGame @relation(fields: [preSaleGameId], references: [id], onDelete: Cascade)
}

// ========== FIM PRÉ-ESTREIA ==========

// Patrocinadores
model Sponsor {
  id         String    @id @default(cuid())
  name       String    @map("name")
  websiteUrl String?   @map("website_url")
  logoUrl    String    @map("logo_url")
  tier       String    @default("APOIO") @map("tier") // MASTER | OFICIAL | APOIO
  priority   Int       @default(0) @map("priority")
  isActive   Boolean   @default(true) @map("is_active")
  startAt    DateTime? @map("start_at")
  endAt      DateTime? @map("end_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
}

// Configurações gerais do site (contato, redes, CNPJ)
model SiteSettings {
  id             String   @id @default(cuid())
  supportEmail   String?  @map("support_email")
  whatsappNumber String?  @map("whatsapp_number")
  instagramUrl   String?  @map("instagram_url")
  tiktokUrl      String?  @map("tiktok_url")
  youtubeUrl     String?  @map("youtube_url")
  companyName    String?  @map("company_name")
  companyCnpj    String?  @map("company_cnpj")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
}

// ========== E-MAILS TRANSiCIONAIS (Resend) ==========
model EmailSettings {
  id           String   @id @default(cuid())
  fromName     String   @default("Fly Games") @map("from_name")
  fromEmail    String   @default("no-reply@flygames.com.br") @map("from_email")
  replyTo      String?  @map("reply_to")
  brandColor   String   @default("#22c55e") @map("brand_color")
  logoUrl      String?  @map("logo_url")
  supportEmail String?  @map("support_email")
  whatsappUrl  String?  @map("whatsapp_url")
  footerText   String?  @map("footer_text")
  appBaseUrl   String?  @map("app_base_url")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
}

model EmailTemplate {
  id        String   @id @default(cuid())
  key       String   @unique @map("key") // WELCOME | VERIFY_EMAIL | RESET_PASSWORD | PASSWORD_CHANGED
  subject   String   @map("subject")
  htmlBody  String   @map("html_body")
  isActive  Boolean  @default(true) @map("is_active")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model EmailToken {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  type       String    @map("type") // VERIFY_EMAIL | RESET_PASSWORD
  tokenHash  String    @unique @map("token_hash")
  expiresAt  DateTime  @map("expires_at")
  usedAt     DateTime? @map("used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  ip         String?   @map("ip")
  userAgent  String?   @map("user_agent")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailLog {
  id               String   @id @default(cuid())
  userId           String?  @map("user_id")
  toEmail          String   @map("to_email")
  templateKey      String   @map("template_key")
  provider         String   @default("RESEND") @map("provider")
  status           String   @map("status") // SENT | FAILED
  providerMessageId String? @map("provider_message_id")
  errorMessage     String?  @map("error_message")
  createdAt        DateTime @default(now()) @map("created_at")
}

model RateLimit {
  id          String   @id @default(cuid())
  key         String   @unique @map("key")
  count       Int      @default(0) @map("count")
  windowStart DateTime @map("window_start")
  updatedAt   DateTime @updatedAt @map("updated_at")
}

// ========== FIM E-MAILS ==========

model Purchase {
  id               String    @id @default(cuid())
  userId           String    @map("user_id")
  planId           String    @map("plan_id")
  gameId           String?   @map("game_id") // preenchido para plano unitário (jogo específico)
  purchasedAt      DateTime  @default(now()) @map("purchased_at")
  expiresAt       DateTime? @map("expires_at") // null = não expira
  paymentStatus   String    @default("pending") @map("payment_status") // pending | paid | failed | refunded
  paymentGateway  String?   @map("payment_gateway") // woovi | stripe | manual
  externalId      String?   @map("external_id") // id da cobrança no gateway
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id], onDelete: Restrict)
  game Game? @relation(fields: [gameId], references: [id], onDelete: SetNull)
}
