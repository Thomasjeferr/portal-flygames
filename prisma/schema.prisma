generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String    @map("password_hash")
  role          String    @default("user") // "user" | "admin" | "club_viewer"
  emailVerified Boolean   @default(false) @map("email_verified")
  resetToken    String?   @map("reset_token")
  resetExpires  DateTime? @map("reset_expires")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  subscription      Subscription?
  sessions          Session[]
  purchases         Purchase[]
  livePurchases     LivePurchase[]
  emailTokens       EmailToken[]
  clubViewerAccount ClubViewerAccount?
  teamManagers      TeamManager[]
  partners          Partner[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subscription {
  id                    String    @id @default(cuid())
  userId                String    @unique @map("user_id")
  planId                String?   @map("plan_id")
  active                Boolean   @default(false)
  startDate             DateTime  @map("start_date")
  endDate               DateTime  @map("end_date")
  paymentGateway        String?   @map("payment_gateway") // stripe | woovi | manual
  externalSubscriptionId String?  @map("external_subscription_id")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan? @relation(fields: [planId], references: [id], onDelete: SetNull)
}

model Category {
  id        String   @id @default(cuid())
  name      String   @map("name")
  slug      String   @unique @map("slug")
  order     Int      @default(0) @map("order")
  active    Boolean  @default(true) @map("active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  games              Game[]
  preSaleGamesGrade  PreSaleGame[]  // pré-estreias que, quando publicadas, aparecem nesta categoria na grade
}

model Team {
  id             String    @id @default(cuid())
  name           String    @map("name")
  shortName      String?   @map("short_name")
  slug           String    @unique @map("slug")
  city           String?   @map("city")
  state          String?   @map("state")
  foundedYear    Int?      @map("founded_year")
  colors         String?   @map("colors") // JSON: { primary, secondary }
  crestUrl       String?   @map("crest_url")
  instagram      String?   @map("instagram")
  whatsapp       String?   @map("whatsapp")
  description      String?   @map("description")
  responsibleName   String?   @map("responsible_name") // nome do responsável (formulário cadastro)
  responsibleEmail  String?   @map("responsible_email") // e-mail para confirmação e aprovação
  panelAccessToken  String?   @unique @map("panel_access_token") // link de acesso ao painel (enviado por e-mail)
  panelTokenExpiresAt DateTime? @map("panel_token_expires_at")
  isActive          Boolean   @default(true) @map("is_active")
  approvalStatus   String    @default("approved") @map("approval_status") // approved | pending | rejected
  payoutPixKey     String?   @map("payout_pix_key")
  payoutName     String?   @map("payout_name")
  payoutDocument String?   @map("payout_document")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  homeGames   Game[] @relation("HomeTeam")
  awayGames   Game[] @relation("AwayTeam")
  sponsors    Sponsor[]
  sponsorOrders SponsorOrder[]
  sponsorshipEarnings TeamSponsorshipEarning[]
  planEarnings        TeamPlanEarning[]
  purchases           Purchase[]
  managers            TeamManager[]
  members             TeamMember[]
}

// Responsáveis pelo time (usuários que gerenciam o time no painel do clube)
model TeamManager {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  teamId    String   @map("team_id")
  role      String   @default("OWNER") @map("role") // OWNER | ASSISTANT
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("team_managers")
}

// Elenco / membros do time (jogadores, comissão técnica, staff)
model TeamMember {
  id        String   @id @default(cuid())
  teamId    String   @map("team_id")
  name      String   @map("name")
  role      String   @map("role") // PLAYER | COACH | STAFF | GOALKEEPER | etc
  number    Int?     @map("number")
  position  String?  @map("position")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("team_members")
}

model Game {
  id           String    @id @default(cuid())
  title        String
  slug         String    @unique
  championship String    @map("championship")
  gameDate     DateTime  @map("game_date")
  description  String?
  videoUrl     String?   @map("video_url")
  thumbnailUrl String?   @map("thumbnail_url")
  featured     Boolean   @default(false)
  categoryId   String?   @map("category_id")
  homeTeamId   String?   @map("home_team_id")
  awayTeamId   String?   @map("away_team_id")
  order        Int       @default(0) @map("order")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  category    Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  homeTeam    Team?      @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: SetNull)
  awayTeam    Team?      @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: SetNull)
  purchases   Purchase[]
  homeBanners HomeBanner[]
  playEvents  PlayEvent[]
}

model Plan {
  id                String   @id @default(cuid())
  name              String   @map("name")
  type              String   @map("type") // unitario | recorrente
  periodicity       String   @map("periodicity") // mensal | anual | personalizado
  price             Float    @map("price")
  description       String?  @map("description")
  active            Boolean  @default(true) @map("active")
  acessoTotal       Boolean  @default(true) @map("acesso_total")
  duracaoDias       Int?     @map("duracao_dias") // null = ilimitado para unitário
  renovacaoAuto     Boolean  @default(false) @map("renovacao_auto")
  teamPayoutPercent Int      @default(0) @map("team_payout_percent") // 0-100: % que vai para o time (time de coração)
  maxConcurrentStreams Int?  @map("max_concurrent_streams") // null = sem limite explícito
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  purchases     Purchase[]
  subscriptions Subscription[]
}

model PaymentConfig {
  id                     String   @id @default(cuid())
  wooviApiKey            String?  @map("woovi_api_key")
  wooviWebhookSecret     String?  @map("woovi_webhook_secret")
  stripeSecretKey        String?  @map("stripe_secret_key")
  stripeWebhookSecret    String?  @map("stripe_webhook_secret")
  stripePublishableKey   String?  @map("stripe_publishable_key")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
}

// Banner frontal da home: imagem ou vídeo (YouTube/PandaVideo) + overlay (legado)
model HeroConfig {
  id                String   @id @default(cuid())
  heroType          String   @default("none") @map("hero_type") // none | image | youtube | pandavideo
  heroMediaUrl      String?  @map("hero_media_url")
  overlayColor      String   @default("#000000") @map("overlay_color") // hex
  overlayOpacity    Float    @default(0.5) @map("overlay_opacity") // 0-1
  videoStartSeconds Int?    @map("video_start_seconds")
  videoEndSeconds   Int?    @map("video_end_seconds")
  videoLoop         Boolean  @default(true) @map("video_loop")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
}

// Hero Banner Inteligente - carrossel configurável via Admin
model HomeBanner {
  id                  String    @id @default(cuid())
  isActive            Boolean   @default(true) @map("is_active")
  priority            Int       @default(0) @map("priority")
  type                String    @map("type") // MANUAL | FEATURED_GAME | FEATURED_PRE_SALE | FEATURED_LIVE

  badgeText           String?   @map("badge_text")
  headline            String?   @map("headline")
  subheadline         String?   @map("subheadline")

  useDefaultCta       Boolean   @default(true) @map("use_default_cta")
  primaryCtaText      String?   @map("primary_cta_text")
  primaryCtaUrl       String?   @map("primary_cta_url")
  secondaryCtaText    String?   @map("secondary_cta_text")
  secondaryCtaUrl     String?   @map("secondary_cta_url")

  mediaType           String    @default("NONE") @map("media_type") // IMAGE | YOUTUBE_VIDEO | MP4_VIDEO | NONE
  mediaUrl            String?   @map("media_url")
  videoStartSeconds   Int       @default(0) @map("video_start_seconds")
  videoEndSeconds     Int?      @map("video_end_seconds")
  loop                Boolean   @default(true) @map("loop")
  mute                Boolean   @default(true) @map("mute")

  overlayColorHex     String    @default("#000000") @map("overlay_color_hex")
  overlayOpacity      Int       @default(75) @map("overlay_opacity") // 0-100

  heightPreset        String    @default("md") @map("height_preset") // sm | md | lg | xl | full

  secondaryMediaType  String    @default("NONE") @map("secondary_media_type") // NONE | IMAGE | YOUTUBE_VIDEO | MP4_VIDEO
  secondaryMediaUrl   String?   @map("secondary_media_url")

  gameId              String?   @map("game_id")
  preSaleId           String?   @map("pre_sale_id")
  liveId              String?   @map("live_id")

  showOnlyWhenReady   Boolean   @default(true) @map("show_only_when_ready")
  startAt             DateTime? @map("start_at")
  endAt               DateTime? @map("end_at")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  game    Game?       @relation(fields: [gameId], references: [id], onDelete: SetNull)
  preSale PreSaleGame? @relation(fields: [preSaleId], references: [id], onDelete: SetNull)
  live    Live?       @relation(fields: [liveId], references: [id], onDelete: SetNull)
}

// ========== PRÉ-ESTREIA CLUBES ==========
// Categorias para pré-estreia (NORMAL = catálogo, SPECIAL = pré-venda)
model PreSaleCategory {
  id        String   @id @default(cuid())
  name      String   @map("name")
  slug      String   @unique @map("slug")
  type      String   @map("type") // NORMAL | SPECIAL
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  preSaleGamesAsSpecial PreSaleGame[]           @relation("SpecialCategory")
  preSaleGameCategories PreSaleGameCategory[]
}

model PreSaleGame {
  id                    String    @id @default(cuid())
  title                 String    @map("title")
  description           String    @map("description")
  thumbnailUrl          String    @map("thumbnail_url")
  videoUrl              String?   @map("video_url")
  status                String    @default("PRE_SALE") @map("status") // PRE_SALE | FUNDED | PUBLISHED
  specialCategoryId     String    @map("special_category_id")
  gradeCategoryId       String?   @map("grade_category_id")  // categoria da grade convencional (quando publicado)
  featured              Boolean   @default(false) @map("featured")
  maxSimultaneousPerClub Int      @map("max_simultaneous_per_club")
  clubAPrice            Float     @map("club_a_price")
  clubBPrice            Float     @map("club_b_price")
  fundedClubsCount      Int       @default(0) @map("funded_clubs_count")
  slug                  String    @unique @map("slug")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  specialCategory   PreSaleCategory       @relation("SpecialCategory", fields: [specialCategoryId], references: [id], onDelete: Restrict)
  gradeCategory     Category?             @relation(fields: [gradeCategoryId], references: [id], onDelete: SetNull)
  normalCategories  PreSaleGameCategory[]
  clubSlots         PreSaleClubSlot[]
  streamSessions   ClubStreamSession[]
  homeBanners      HomeBanner[]
}

model PreSaleGameCategory {
  id             String      @id @default(cuid())
  preSaleGameId  String      @map("pre_sale_game_id")
  categoryId     String      @map("category_id")
  createdAt      DateTime    @default(now()) @map("created_at")

  preSaleGame PreSaleGame    @relation(fields: [preSaleGameId], references: [id], onDelete: Cascade)
  category    PreSaleCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([preSaleGameId, categoryId])
}

model PreSaleClubSlot {
  id                  String     @id @default(cuid())
  preSaleGameId       String     @map("pre_sale_game_id")
  slotIndex           Int        @map("slot_index") // 1 or 2
  clubCode            String     @unique @map("club_code")
  responsibleName     String     @map("responsible_name")
  responsibleEmail    String?    @map("responsible_email")
  clubName            String     @map("club_name")
  teamMemberCount     Int        @map("team_member_count")
  contractVersion     String     @map("contract_version")
  termsAcceptedAt     DateTime   @map("terms_accepted_at")
  paymentStatus       String     @default("PENDING") @map("payment_status") // PENDING | PAID | FAILED
  paymentProvider     String?    @map("payment_provider") // WOOVI | STRIPE
  paymentReference    String?    @map("payment_reference")
  paidAt              DateTime?  @map("paid_at")
  credentialsSentAt   DateTime?  @map("credentials_sent_at")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")

  preSaleGame      PreSaleGame       @relation(fields: [preSaleGameId], references: [id], onDelete: Cascade)
  clubViewerAccount ClubViewerAccount?
}

model ClubViewerAccount {
  id                 String   @id @default(cuid())
  userId             String   @unique @map("user_id")
  preSaleClubSlotId  String   @unique @map("pre_sale_club_slot_id")
  loginUsername      String   @unique @map("login_username") // usuário exibido ao clube e no admin
  createdAt          DateTime @default(now()) @map("created_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  preSaleClubSlot PreSaleClubSlot @relation(fields: [preSaleClubSlotId], references: [id], onDelete: Cascade)
}

model ClubStreamSession {
  id             String    @id @default(cuid())
  preSaleGameId  String    @map("pre_sale_game_id")
  clubCode       String    @map("club_code")
  sessionToken   String    @unique @map("session_token")
  userId         String?   @map("user_id")
  deviceId       String?   @map("device_id")
  lastHeartbeatAt DateTime @map("last_heartbeat_at")
  expiresAt      DateTime  @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  preSaleGame PreSaleGame @relation(fields: [preSaleGameId], references: [id], onDelete: Cascade)
}

// ========== FIM PRÉ-ESTREIA ==========

// Planos de Patrocínio (pacotes vendíveis)
model SponsorPlan {
  id                String   @id @default(cuid())
  name              String   @map("name")
  price             Float    @map("price")
  billingPeriod     String   @default("monthly") @map("billing_period") // monthly | quarterly | yearly
  benefits          String   @default("[]") @map("benefits") // JSON array de strings
  featuresFlags     String   @default("{}") @map("features_flags") // JSON ex: { show_in_footer, show_in_player, ... }
  teamPayoutPercent Int      @default(0) @map("team_payout_percent") // 0-100: % do valor que vai para o time
  sortOrder         Int      @default(0) @map("sort_order")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  sponsors      Sponsor[]
  sponsorOrders SponsorOrder[]
}

// Pedido de patrocínio (compra pelo site, antes de virar Sponsor)
model SponsorOrder {
  id               String    @id @default(cuid())
  sponsorPlanId    String    @map("sponsor_plan_id")
  teamId           String?   @map("team_id")
  partnerId        String?   @map("partner_id")
  companyName      String    @map("company_name")
  email            String    @map("email")
  websiteUrl       String?   @map("website_url")
  whatsapp         String?   @map("whatsapp")
  logoUrl          String    @map("logo_url")
  amountCents      Int       @map("amount_cents")
  amountToTeamCents Int      @default(0) @map("amount_to_team_cents")
  paymentStatus    String    @default("pending") @map("payment_status") // pending | paid | failed
  paymentGateway   String?   @map("payment_gateway")
  externalId       String?   @map("external_id")
  utmSource        String?   @map("utm_source")
  utmMedium        String?   @map("utm_medium")
  utmCampaign      String?   @map("utm_campaign")
  utmContent       String?   @map("utm_content")
  utmTerm          String?   @map("utm_term")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  sponsorPlan SponsorPlan @relation(fields: [sponsorPlanId], references: [id], onDelete: Restrict)
  team        Team?       @relation(fields: [teamId], references: [id], onDelete: SetNull)
  partner     Partner?    @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  earnings    TeamSponsorshipEarning[]
}

// Ganho do time com patrocínio (comissão)
model TeamSponsorshipEarning {
  id               String    @id @default(cuid())
  teamId           String    @map("team_id")
  sponsorOrderId   String    @map("sponsor_order_id")
  amountCents      Int       @map("amount_cents")
  status           String    @default("pending") @map("status") // pending | paid
  paidAt           DateTime? @map("paid_at")
  paymentReference String?   @map("payment_reference")
  createdAt        DateTime  @default(now()) @map("created_at")

  team         Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  sponsorOrder SponsorOrder @relation(fields: [sponsorOrderId], references: [id], onDelete: Cascade)

  @@unique([teamId, sponsorOrderId])
}

// Patrocinadores
model Sponsor {
  id         String       @id @default(cuid())
  name       String       @map("name")
  websiteUrl String?      @map("website_url")
  logoUrl    String       @map("logo_url")
  tier       String       @default("APOIO") @map("tier") // MASTER | OFICIAL | APOIO
  priority   Int          @default(0) @map("priority")
  isActive   Boolean      @default(true) @map("is_active")
  startAt    DateTime?    @map("start_at")
  endAt      DateTime?    @map("end_at")
  planId     String?      @map("plan_id")
  teamId     String?      @map("team_id")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  plan SponsorPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)
  team Team?        @relation(fields: [teamId], references: [id], onDelete: SetNull)
}

// Configurações gerais do site (contato, redes, CNPJ)
model SiteSettings {
  id                     String   @id @default(cuid())
  supportEmail           String?  @map("support_email")
  adminCredentialsEmail  String?  @map("admin_credentials_email") // e-mail que recebe credenciais pré-estreia
  whatsappNumber         String?  @map("whatsapp_number")
  instagramUrl           String?  @map("instagram_url")
  tiktokUrl              String?  @map("tiktok_url")
  youtubeUrl             String?  @map("youtube_url")
  companyName            String?  @map("company_name")
  companyCnpj            String?  @map("company_cnpj")
  gaMeasurementId        String?  @map("ga_measurement_id")
  fbPixelId              String?  @map("fb_pixel_id")
  tiktokPixelId          String?  @map("tiktok_pixel_id")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
}

// ========== E-MAILS TRANSiCIONAIS (Resend) ==========
model EmailSettings {
  id           String   @id @default(cuid())
  fromName     String   @default("Fly Games") @map("from_name")
  fromEmail    String   @default("no-reply@flygames.com.br") @map("from_email")
  replyTo      String?  @map("reply_to")
  brandColor   String   @default("#22c55e") @map("brand_color")
  logoUrl      String?  @map("logo_url")
  supportEmail String?  @map("support_email")
  whatsappUrl  String?  @map("whatsapp_url")
  footerText   String?  @map("footer_text")
  appBaseUrl   String?  @map("app_base_url")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
}

model EmailTemplate {
  id        String   @id @default(cuid())
  key       String   @unique @map("key") // WELCOME | VERIFY_EMAIL | RESET_PASSWORD | PASSWORD_CHANGED
  subject   String   @map("subject")
  htmlBody  String   @map("html_body")
  isActive  Boolean  @default(true) @map("is_active")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model EmailToken {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  type       String    @map("type") // VERIFY_EMAIL | RESET_PASSWORD
  tokenHash  String    @unique @map("token_hash")
  expiresAt  DateTime  @map("expires_at")
  usedAt     DateTime? @map("used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  ip         String?   @map("ip")
  userAgent  String?   @map("user_agent")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailLog {
  id               String   @id @default(cuid())
  userId           String?  @map("user_id")
  toEmail          String   @map("to_email")
  templateKey      String   @map("template_key")
  provider         String   @default("RESEND") @map("provider")
  status           String   @map("status") // SENT | FAILED
  providerMessageId String? @map("provider_message_id")
  errorMessage     String?  @map("error_message")
  createdAt        DateTime @default(now()) @map("created_at")
}

model RateLimit {
  id          String   @id @default(cuid())
  key         String   @unique @map("key")
  count       Int      @default(0) @map("count")
  windowStart DateTime @map("window_start")
  updatedAt   DateTime @updatedAt @map("updated_at")
}

// ========== ANALYTICS / GEOLOCALIZAÇÃO ==========
model VisitLog {
  id        String   @id @default(cuid())
  ipHash    String   @map("ip_hash") // hash do IP para privacidade
  country   String?  @map("country")
  countryCode String? @map("country_code")
  region    String?  @map("region")
  regionName String? @map("region_name")
  city      String?  @map("city")
  lat       Float?   @map("lat")
  lng       Float?   @map("lng")
  timezone  String?  @map("timezone")
  isp       String?  @map("isp")
  userAgent String?  @map("user_agent")
  pagePath  String   @map("page_path")
  referrer  String?  @map("referrer")
  createdAt DateTime @default(now()) @map("created_at")
}

model IpGeoCache {
  id         String   @id @default(cuid())
  ipHash     String   @unique @map("ip_hash")
  country    String?  @map("country")
  countryCode String? @map("country_code")
  region     String?  @map("region")
  regionName String?  @map("region_name")
  city       String?  @map("city")
  lat        Float?   @map("lat")
  lng        Float?   @map("lng")
  timezone   String?  @map("timezone")
  isp        String?  @map("isp")
  cachedAt   DateTime @default(now()) @map("cached_at")
}

// ========== FIM E-MAILS ==========

model Purchase {
  id                 String    @id @default(cuid())
  userId             String    @map("user_id")
  planId             String    @map("plan_id")
  gameId             String?   @map("game_id") // preenchido para plano unitário (jogo específico)
  teamId             String?   @map("team_id") // time de coração (opcional)
  partnerId          String?   @map("partner_id") // parceiro/revendedor (opcional)
  amountToTeamCents  Int       @default(0) @map("amount_to_team_cents")
  purchasedAt        DateTime  @default(now()) @map("purchased_at")
  expiresAt          DateTime? @map("expires_at") // null = não expira
  paymentStatus      String    @default("pending") @map("payment_status") // pending | paid | failed | refunded
  paymentGateway     String?   @map("payment_gateway") // woovi | stripe | manual
  externalId         String?   @map("external_id") // id da cobrança no gateway
  utmSource          String?   @map("utm_source")
  utmMedium          String?   @map("utm_medium")
  utmCampaign        String?   @map("utm_campaign")
  utmContent         String?   @map("utm_content")
  utmTerm            String?   @map("utm_term")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan    Plan     @relation(fields: [planId], references: [id], onDelete: Restrict)
  game    Game?    @relation(fields: [gameId], references: [id], onDelete: SetNull)
  team    Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  partner Partner? @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  planEarnings TeamPlanEarning[]
}

// Programa de parceiros / revendedores
model Partner {
  id                       String   @id @default(cuid())
  userId                   String?  @map("user_id")
  type                     String   @default("revendedor") @map("type") // revendedor | influencer | lojista | outro
  status                   String   @default("pending") @map("status") // pending | approved | rejected | blocked
  name                     String   @map("name")
  companyName              String?  @map("company_name")
  document                 String?  @map("document") // CPF ou CNPJ
  whatsapp                 String?  @map("whatsapp")
  city                     String?  @map("city")
  state                    String?  @map("state")
  refCode                  String   @unique @map("ref_code")
  planCommissionPercent    Int      @default(0) @map("plan_commission_percent") // % sobre planos/assinaturas
  gameCommissionPercent    Int      @default(0) @map("game_commission_percent") // % sobre jogos/lives avulsos
  sponsorCommissionPercent Int      @default(0) @map("sponsor_commission_percent") // % sobre patrocínio
  pixKey                   String?  @map("pix_key")
  pixKeyType               String?  @map("pix_key_type") // cpf | cnpj | email | phone | aleatoria
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  user      User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  purchases Purchase[]
  sponsorOrders SponsorOrder[]
  earnings  PartnerEarning[]
}

model PartnerEarning {
  id               String    @id @default(cuid())
  partnerId        String    @map("partner_id")
  sourceType       String    @map("source_type") // purchase | sponsor
  sourceId         String    @map("source_id")
  grossAmountCents Int       @map("gross_amount_cents")
  commissionPercent Int      @map("commission_percent")
  amountCents      Int       @map("amount_cents")
  status           String    @default("pending") @map("status") // pending | paid
  paidAt           DateTime? @map("paid_at")
  paymentReference String?   @map("payment_reference")
  createdAt        DateTime  @default(now()) @map("created_at")

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
}

// Ganho do time com compra de plano/jogo (comissão do time de coração)
model TeamPlanEarning {
  id               String    @id @default(cuid())
  teamId           String    @map("team_id")
  purchaseId       String    @map("purchase_id")
  amountCents      Int       @map("amount_cents")
  status           String    @default("pending") @map("status") // pending | paid
  paidAt           DateTime? @map("paid_at")
  paymentReference String?   @map("payment_reference")
  createdAt        DateTime  @default(now()) @map("created_at")

  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@unique([teamId, purchaseId])
}

// ========== DASHBOARD / ANALYTICS ==========
model PlayEvent {
  id        String    @id @default(cuid())
  userId    String?   @map("user_id")
  gameId    String    @map("game_id")
  createdAt DateTime  @default(now()) @map("created_at")

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

model Payment {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  provider  String   @map("provider") // STRIPE | WOOVI
  type      String   @map("type") // SUBSCRIPTION | ONE_TIME
  amount    Float    @map("amount")
  status    String   @map("status") // PAID | PENDING | FAILED
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

// ========== LIVES (Cloudflare Stream Live + OBS) ==========
model Live {
  id                      String    @id @default(cuid())
  title                   String    @map("title")
  description             String?   @map("description")
  thumbnailUrl            String?   @map("thumbnail_url")
  cloudflareLiveInputId   String?   @unique @map("cloudflare_live_input_id")
  cloudflarePlaybackId    String?   @map("cloudflare_playback_id") // video uid quando gravado (replay)
  status                  String    @default("SCHEDULED") @map("status") // SCHEDULED | LIVE | ENDED
  startAt                 DateTime? @map("start_at")
  endAt                   DateTime? @map("end_at")
  requireSubscription     Boolean   @default(true) @map("require_subscription")
  allowOneTimePurchase    Boolean   @default(false) @map("allow_one_time_purchase")
  allowChat               Boolean   @default(false) @map("allow_chat")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  purchases   LivePurchase[]
  homeBanners HomeBanner[]
}

model LivePurchase {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  liveId      String   @map("live_id")
  purchasedAt DateTime @default(now()) @map("purchased_at")
  paymentStatus String @default("paid") @map("payment_status") // paid | pending | refunded

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  live Live @relation(fields: [liveId], references: [id], onDelete: Cascade)

  @@unique([userId, liveId])
  @@map("live_purchases")
}

// ========== FIM LIVES ==========

model WebhookEvent {
  id        String   @id @default(cuid())
  provider  String   @map("provider") // STRIPE | WOOVI
  eventId   String   @unique @map("event_id")
  status    String   @map("status") // SUCCESS | FAILED
  createdAt DateTime @default(now()) @map("created_at")
}
